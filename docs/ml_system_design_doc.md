# ML System Design Doc

## 1. Зачем идем в разработку продукта?

### Бизнес-цель:
Создать AI-сервис, который:

   * Автоматически формирует КП на основе входящей заявки (письмо, PDF, скан, текст).

   * Сокращает цикл подготовки КП с часов до минут.

   * Обеспечивает единый стиль и корректность терминов в соответствии с внутренней документацией, спецификациями поставщиков и системой бизнес-правил.

   * Повышает скорость отклика на запросы и, как следствие, конверсию заявок в заказы.

### Почему станет лучше, чем сейчас 

| Аспект                  | Как сейчас                                         | Как будет с AI-сервисом                                        |
|-------------------------|---------------------------------------------------|----------------------------------------------------------------|
| Скорость обработки заявки | Ручная работа менеджера (30–60 мин/заявка)       | Автоматическая обработка и генерация КП за 1–2 минуты          |
| Качество и точность КП  | Зависит от компетенции сотрудника                 | Единые стандарты, контроль корректности через LLM и базы спецификаций |
| Человеческий фактор     | Возможны ошибки и пропуски параметров             | LLM извлекает все ключевые параметры из текста/скана          |
| Нагрузка на команду     | Менеджеры перегружены рутиной                     | Освобождение времени под переговоры и развитие клиентов       |
| Интеграция с системами  | Разрозненные шаблоны и Excel                      | Централизованный AI-сервис, интегрируемый с CRM/ERP           |

### Что будем считать успехом итерации 

   * Бизнес-метрики успешной итерации (MVP):

      * Сокращение времени подготовки КП — минимум на 70% по сравнению с ручным процессом.

      * Точность извлечения параметров — не ниже 90% (по сравнению с эталонными данными).

      * Автоматическая генерация КП в корректном шаблоне компании — без ручной правки минимум в 80% случаев.

      * Рост конверсии заявок в заказы — на 10–15% за счёт ускорения отклика клиенту.

      * Положительная оценка пользователей (NPS ≥ 8/10) среди менеджеров по продажам.


## 2. Бизнес-требования и ограничения 
   * Описание Бизнес-Требований (БТ):
      * AI-сервис для автоматической генерации коммерческих предложений (КП) из входящих клиентских заявок (письма, PDF, сканы, текст). Сервис должен:

        * Извлекать ключевые параметры из запроса (товары, количество, спецификации, сроки).

        * Генерировать корректные наименования продукции на основе внутренних каталогов и документации поставщиков.

        * Формировать КП в едином шаблоне компании.

        * Предоставлять возможность редактирования и согласования вручную при необходимости.
      
### Бизнес-ограничения
   * Использование LLM по API (Mistral, Gemini...) для простоты и инференса генерации ответа. 
     * Обоснование: Использование LLM по API стоит выбрать ради максимального интеллекта и скорости обработки, которые не требуют покупки дорогого «железа» и сложной настройки инфраструктуры.

   * Время отклика: Генерация КП должна занимать ≤ 2 минут на одну заявку.

   * Точность данных: Минимум 90% корректности извлечённых параметров.

   * Совместимость с системами: CRM/ERP интеграция должна быть возможна через API.

   * Безопасность данных: Все данные клиентов обрабатываются в соответствии с внутренними стандартами безопасности.

   * Объемы пилота: Пилотная версия должна обрабатывать до 50–100 заявок в день без деградации качества.

   * Редактируемость: Менеджер должен иметь возможность вручную исправить или дополнить сгенерированное КП.

### Что ожидаем от конкретной итерации

   * MVP, способный принимать входящие заявки (PDF, текст) и генерировать корректный черновой КП.

   * Интеграция с каталогом продукции для правильной генерации наименований.

   * Легкий интерфейс для проверки и редактирования сгенерированных КП.

   * Метрики:

      * Скорость генерации ≤ 2 минут

      * Точность извлечения параметров ≥ 90%

      * Минимум 80% КП без ручных правок


### Описание бизнес-процесса пилота

* Процесс пилота:

   * Менеджер получает входящую заявку от клиента (email/PDF/скан).

   * Загружает заявку в AI-сервис.

   * Сервис автоматически анализирует текст, извлекает параметры (товары, количество, сроки, условия) и проверяет их по внутренним каталогам.

   * Генерируется черновой КП в корпоративном шаблоне.

   * Менеджер проверяет КП, при необходимости редактирует и отправляет клиенту.

   * Система сохраняет все данные для анализа и улучшения модели.

* Особенности пилота:

   * Сначала ограниченный поток заявок (например, конкретный продуктовый сегмент или регион).

   * Сбор обратной связи от менеджеров и клиентов для улучшения качества.

   * Логирование всех шагов для дальнейшего анализа.


### Что считаем успешным пилотом

* Критерии успеха:

* * Сокращение времени подготовки КП ≥ 70%

* * Точность извлечения ключевых параметров ≥ 90%

* * Минимум 80% черновых КП не требуют ручных правок

* * Положительная оценка пользователей (NPS ≥ 8/10)

* * Отсутствие критических ошибок в данных и интеграциях

* Возможные пути развития проекта после пилота:

* * Расширение на все продуктовые сегменты и регионы.

* * Интеграция с CRM для автоматической отправки КП клиенту.

* * Подключение генерации коммерческих условий и скидок на основе правил.

* * Обучение модели на реальных КП для повышения точности и улучшения формулировок.


## 3. Что входит в скоуп проекта/итерации

* В рамках итерации мы закрываем:

* * Разработка прототипа модели (LLM/VLLM) для извлечения ключевых параметров из заявок (текст, PDF, сканы).

* * Генерация черновых коммерческих предложений на основе внутреннего каталога продукции и бизнес-правил.

* * Интеграция с ограниченным набором входных форматов (PDF, текстовые файлы).

* * Метрики качества модели: точность извлечения ≥ 90%, корректность наименований ≥ 80%.

* * Логирование и сохранение всех данных для анализа и дальнейшего обучения.

* Вне скоупа итерации:

* * Полная интеграция со всеми системами ERP/CRM.

* * Обработка изображений/сканов с низким качеством OCR.

* * Автоматическая генерация условий скидок и ценовых предложений.

* * Поддержка всех сегментов продуктов компании.

* * Автоматическая отправка КП клиенту.


### На закрытие каких БТ подписываемся в данной итерации

* Извлечение ключевых параметров (товар, количество, сроки) из ограниченного набора форматов заявок.

* Генерация корректного чернового КП в едином шаблоне с минимальными ручными правками.

* Проверка соответствия наименований товаров внутреннему каталогу.

* Сбор метрик производительности модели и точности извлечения.

### Что не будет закрыто

* Расширение на все форматы входящих заявок и все продуктовые сегменты.

* Генерация коммерческих условий и индивидуальных скидок.

* Полная интеграция с внешними системами (CRM/ERP) для автоматической отправки КП.

* Долгосрочная оптимизация LLM для стиля текста и креативной генерации.

### Описание результата с точки зрения качества кода и воспроизводимости решения

* Качество кода:

* * Чистая, модульная архитектура для обработки входящих файлов и генерации КП.

* * Покрытие ключевых функций юнит-тестами (извлечение параметров, генерация текста).

* * Документация функций и шагов обработки данных.

* Воспроизводимость решения:

* * Возможность повторно обучить/дообучить модель на новых данных.

* * Легкая смена каталога продукции и бизнес-правил без изменения кода.

* * Логирование всех шагов обработки для анализа и отладки.

### Планируемый технический долг

* Ограниченный набор форматов заявок (PDF/текст) — OCR для сканов с низким качеством пока не реализован.

* Частичная интеграция с ERP/CRM (API для массовой генерации КП пока не подключен).

* Статические правила для генерации наименований вместо динамического обучения модели на всех кейсах.

* Минимальная обработка ошибок редких кейсов и некорректных данных.

* Отложена автоматическая генерация условий/цен.


## 4. Предпосылки решения

### Горизонт и характер обработки
#### Горизонт анализа

* Поскольку функция — генерация КП в момент получения заявки, модель работает:

* * В режиме реального времени,

* * Сразу при загрузке файла менеджером.

* Обоснование: бизнес запросил сокращение цикла отклика клиенту → нужен быстрый inference.

### Гранулярность обработки

#### Модель должна работать на уровне одной заявки, независимо от других.

* Гранулярность:

   * Анализ одного документа (или одной цепочки писем).

   * Извлечение параметров конкретного заказа.

   * Генерация 1 чернового КП → ручная проверка → клиенту.

* Обоснование:
КП всегда привязано к конкретному запросу, цеплять другие документы нельзя — риск ошибки и нарушения требований клиента.

### Предпосылки о качестве данных
#### Предположения о текстах

* Данные преимущественно структурированно-неструктурированные (текст с частичной структурой).

* Присутствует вариативность терминов, но в пределах нормального переговорного процесса.

* OCR-проблемы минимальны — допускаем легкие искажения, но без сильных артефактов.

#### Обоснование:
Бизнес сказал, что большинство PDF — это исходные документы от клиентов, не сканы факсов.

#### Предположения о каталогах

* Каталоги актуальны и обновляются бизнесом.

* SKU(Stock keeping unit) уникальны.

* В каталоге достаточно данных, чтобы однозначно сформировать товарное наименование.

#### Обоснование:
LLM не может “догадаться”, если каталоги неполные → мы опираемся на готовые данные бизнеса.

### Предпосылки о работе LLM и логике системы
* Предпосылка о достаточности LLM

   * LLM сможет:

      * Корректно извлекать сущности (товар, количество, параметры).

      * Соотносить параметры с каталогом (через RAG или правила).

      * Генерировать корректное наименование на основе бизнес-логики.

* Обоснование:
Задача — комбинирование извлечения + генерации, что полностью соответствует LLM-based pipeline.

* Ограничения модели

   * Мы предполагаем, что:

   * * Модель не должна принимать решения о ценах, скидках, марже.

   * * Модель не оценивает бизнес-риск.

   * * Модель не делает финальную юридическую проверку документа.

* Обоснование:
Эти функции — зона ответственности менеджеров и ERP.


### Предпосылки о производительности

#### Модель должна работать:

* Inference ≤ 120 секунд

* Поддержка 20–50 запросов/день (пилот)

* Используем LLM по API (MistralAI, openAI, Gemini) 

#### Обоснование: 
бизнес-процесс требует fast response → иначе КП потеряет ценность.


### Предпосылки об обучении и данных для модели

#### Предполагаем:

* У нас доступен корпус минимум 100–300 реальных КП для анализа стиля (не обязательно для обучения).

* У нас есть набор из 500–1000 заявок для отладки промптов и пайплайна.

* Fine-tuning не обязателен на первой итерации → достаточно RAG + prompting.

#### Обоснование:
* Бизнес хочет быстро получить работающий MVP, fine-tune — позже, после сбора фидбэка.

### Предпосылки по роли человека в цикле

#### Предполагаем:

* Финальная проверка КП → обязанность менеджера.

* Менеджер может исправить ошибки.

* Менеджер даёт обратную связь (система логирует исправления).

#### Обоснование:
* Фулл-автоматизация сейчас невозможна как юридически, так и методологически.


## 5. Постановка задачи
### Техническая цель проекта:
#### Построить ML/LLM-систему для автоматического формирования коммерческих предложений из клиентских заявок через последовательность этапов:

##### 1. Извлечение информаций поданных на вход

* Определение сущностей: товары, количество, параметры, сроки, условия.

##### 2. Сопоставление с внутренними справочниками

* Соотнесение извлечённых данных с каталогами, спецификациями, бизнес-правилами.

##### 3. Генерация структурированного документа 

* Формирование чернового КП в корпоративном шаблоне с обязательными разделами.

#### Тип задачи: pipeline извлечение → нормализация → генерация документа

## 6. Блок-схема
- [Схема архитектуры решения](https://github.com/Johannmbo/ML_Sys_Design_Project/blob/hw_1/%D0%A1%D1%85%D0%B5%D0%BC%D0%B0_%D1%8D%D1%82%D0%B0%D0%BF%D0%BD%D0%BE%D1%81%D1%82%D0%B8.png)


## hw_3

### 1. Подготовка пилота
### 1.1. Способ оценки пилота

Пилот проводится в формате контролируемого эксперимента на ограниченном наборе входящих клиентских заявок, поступающих в различных форматах:

   * текст писем,

   * PDF-документы,

   * сканы (OCR).

Архитектура пилота включает:

   * обработку входного документа (OCR / parsing),

   * извлечение ключевых параметров заявки,

   * нормализацию и сопоставление с внутренними справочниками и бизнес-правилами,

   * генерацию текста коммерческого предложения с использованием LLM по API (Mistral, OpenAi, Gemini).

Оценка пилота осуществляется в двух режимах:

   * Offline-оценка на исторических заявках с эталонными (ручными) КП.

   * Shadow-mode (без отправки клиенту), где AI-сервис формирует КП параллельно с текущим ручным процессом.

### 1.2. Что считаем успешным пилотом

Пилот считается успешным при выполнении следующих критериев:

1. Качество извлечения и интерпретации заявки

   * Точность извлечения ключевых параметров заявки (номенклатура, количество, характеристики, сроки, условия) - не ниже 90% (по сравнению с эталонными данными).
   (метрика: Precision / Recall / F1 по полям).

   * Корректное сопоставление продукции с внутренними наименованиями и спецификациями ≥ Y%.

2. Качество генерации коммерческого предложения

   * Доля КП, не требующих ручной правки, в 80% случаев.

   * Отсутствие критических ошибок:

   * некорректные наименования продукции,

   * нарушения бизнес-правил,

   * противоречия спецификациям поставщиков.

3. Бизнес-эффект

   * Сокращение среднего времени подготовки КП не менее чем на N%.

   * Снижение нагрузки на сотрудников продаж / пресейла.

   * Нейтральное или положительное влияние на конверсию заявка → КП → сделка (при наличии данных).

4. Надежность и безопасность

   * Отсутствие утечек конфиденциальных данных.

   * Предсказуемость и воспроизводимость результатов при повторных запусках.

### 1.3. Подготовка пилота и вычислительные ограничения

Пилот проектируется с учетом стоимости и ограничений использования LLM по API.

Подход к оценке вычислительных и стоимостных затрат:

   * Baseline-эксперимент

   * Использование минимально сложного пайплайна:

   * OCR + простое извлечение,

   * базовая LLM-модель без chain-of-thought,

   * ограниченный контекст.

Оценка:

   * среднего числа токенов на заявку,

   * времени ответа,

   * стоимости одного КП.

   * Оценка масштабирования

Анализ влияния:

   * увеличения длины входных документов,

   * добавления RAG (внутренние документы, спецификации),

   * усложнения промптов и бизнес-логики.

   * Прогноз стоимости при ожидаемом объеме заявок.

Ограничения пилота

   * лимит токенов на одну заявку;

   * фиксированный список используемых моделей;

   * ограничение времени ответа (SLA);

   * запрет на использование моделей с неконтролируемым поведением;

   * fallback-механизм (шаблонное КП / ручная обработка).

Уточнение параметров пилота

   После baseline-оценки возможна корректировка:

   * объема данных пилота,

   * сложности RAG,

   * глубины валидации бизнес-правил.

### 2. Механизм проведения пилота

Пилот проводится на ограниченном объеме реальных входящих заявок клиентов и не влияет напрямую на взаимодействие с клиентами на начальном этапе.

#### Формат пилота

Режим shadow-mode:
   * AI-сервис автоматически формирует КП параллельно текущему ручному процессу. Сформированные КП не отправляются клиентам и используются только для оценки качества.

   * Источник данных:
   Исторические и новые заявки клиентов в различных форматах (email, PDF, сканы, текстовые файлы).

#### Архитектура обработки:

   * Прием и классификация входящего документа;

   * OCR / парсинг текста (при необходимости);

   * Извлечение ключевых параметров заявки;

   * Сопоставление с внутренними справочниками, спецификациями и бизнес-правилами;

   * Генерация текста коммерческого предложения с использованием LLM по API;

   * Логирование результатов и метаданных (время, токены, ошибки).

### Способ оценки успешности пилота

Успешность пилота оценивается по совокупности качественных, бизнес- и технических метрик.

1. Качество извлечения и интерпретации заявки

      * Точность извлечения ключевых параметров (номенклатура, количество, характеристики, условия);

      * Корректность сопоставления продукции с внутренними наименованиями и спецификациями;

      * Доля заявок, корректно обработанных без потери критической информации.

2. Качество сформированного коммерческого предложения

   Доля КП, не требующих или требующих минимальной ручной правки;

   Количество критических ошибок:

   * некорректные наименования продукции,

   * нарушения бизнес-правил,

   * логические противоречия.

   * Соответствие структуре и стандартам компании.

3. Бизнес-эффект

   * Сокращение среднего времени подготовки КП;

   * Снижение ручной нагрузки на сотрудников;

   * Потенциальное влияние на конверсию заявка → КП (оценивается при достаточном объеме данных).

4. Технические и эксплуатационные показатели

   * Среднее и 95-й перцентиль времени ответа;

   * Стоимость генерации одного КП;

   * Стабильность работы и частота ошибок;

   * Предсказуемость результата при повторных запусках.

### Критерий успешного пилота

Пилот считается успешным, если:

   * ключевые качественные метрики превышают показатели бейзлайна;

   * достигается значимое сокращение времени подготовки КП;

   * стоимость и латентность укладываются в заданные ограничения;

   * отсутствуют критические ошибки, делающие КП непригодным для использования.

### Подготовительные шаги
1. Подготовка данных

   * Сбор и очистка исторических заявок и соответствующих КП;

   * Формирование репрезентативной выборки для пилота;

   * Обезличивание конфиденциальных данных (при необходимости).

2. Формализация требований и правил

   * Описание структуры коммерческого предложения;

   * Формализация бизнес-правил и ограничений;

   * Подготовка справочников продукции и спецификаций поставщиков.

3. Baseline-оценка

   Запуск минимального пайплайна (простая модель / базовый промпт);

   Оценка:

   * времени обработки,

   * потребления токенов,

   * стоимости одного КП.

   * Использование результатов для установки ограничений пилота.

4. Настройка метрик и процесса оценки

   * Определение метрик качества и их пороговых значений;

   * Подготовка чек-листов для экспертной оценки;

   * Настройка логирования и мониторинга.

5. Ограничения и контроль

   * Лимиты на количество токенов и время ответа;

   * Ограниченный список используемых моделей;

   * Fallback-механизмы (шаблонное КП / ручная обработка);

   * Регламент остановки пилота при выявлении критических ошибок.