# ML System Design Doc

## 1. Зачем идем в разработку продукта?

### Бизнес-цель:
Создать AI-сервис, который:

   * Автоматически формирует КП на основе входящей заявки (письмо, PDF, скан, текст).

   * Сокращает цикл подготовки КП с часов до минут.

   * Обеспечивает единый стиль и корректность терминов в соответствии с внутренней документацией, спецификациями поставщиков и системой бизнес-правил.

   * Повышает скорость отклика на запросы и, как следствие, конверсию заявок в заказы.

### Почему станет лучше, чем сейчас 

| Аспект                  | Как сейчас                                         | Как будет с AI-сервисом                                        |
|-------------------------|---------------------------------------------------|----------------------------------------------------------------|
| Скорость обработки заявки | Ручная работа менеджера (30–60 мин/заявка)       | Автоматическая обработка и генерация КП за 1–2 минуты          |
| Качество и точность КП  | Зависит от компетенции сотрудника                 | Единые стандарты, контроль корректности через LLM и базы спецификаций |
| Человеческий фактор     | Возможны ошибки и пропуски параметров             | LLM извлекает все ключевые параметры из текста/скана          |
| Нагрузка на команду     | Менеджеры перегружены рутиной                     | Освобождение времени под переговоры и развитие клиентов       |
| Интеграция с системами  | Разрозненные шаблоны и Excel                      | Централизованный AI-сервис, интегрируемый с CRM/ERP           |

### Что будем считать успехом итерации 

   * Бизнес-метрики успешной итерации (MVP):

      * Сокращение времени подготовки КП — минимум на 70% по сравнению с ручным процессом.

      * Точность извлечения параметров — не ниже 90% (по сравнению с эталонными данными).

      * Автоматическая генерация КП в корректном шаблоне компании — без ручной правки минимум в 80% случаев.

      * Рост конверсии заявок в заказы — на 10–15% за счёт ускорения отклика клиенту.

      * Положительная оценка пользователей (NPS ≥ 8/10) среди менеджеров по продажам.


## 2. Бизнес-требования и ограничения 
   * Описание Бизнес-Требований (БТ):
      * AI-сервис для автоматической генерации коммерческих предложений (КП) из входящих клиентских заявок (письма, PDF, сканы, текст). Сервис должен:

        * Извлекать ключевые параметры из запроса (товары, количество, спецификации, сроки).

        * Генерировать корректные наименования продукции на основе внутренних каталогов и документации поставщиков.

        * Формировать КП в едином шаблоне компании.

        * Предоставлять возможность редактирования и согласования вручную при необходимости.
      
### Бизнес-ограничения
   * Время отклика: Генерация КП должна занимать ≤ 2 минут на одну заявку.

   * Точность данных: Минимум 90% корректности извлечённых параметров.

   * Совместимость с системами: CRM/ERP интеграция должна быть возможна через API.

   * Безопасность данных: Все данные клиентов обрабатываются в соответствии с внутренними стандартами безопасности.

   * Объемы пилота: Пилотная версия должна обрабатывать до 50–100 заявок в день без деградации качества.

   * Редактируемость: Менеджер должен иметь возможность вручную исправить или дополнить сгенерированное КП.

### Что ожидаем от конкретной итерации

   * MVP, способный принимать входящие заявки (PDF, текст) и генерировать корректный черновой КП.

   * Интеграция с каталогом продукции для правильной генерации наименований.

   * Легкий интерфейс для проверки и редактирования сгенерированных КП.

   * Метрики:

      * Скорость генерации ≤ 2 минут

      * Точность извлечения параметров ≥ 90%

      * Минимум 80% КП без ручных правок


### Описание бизнес-процесса пилота

* Процесс пилота:

   * Менеджер получает входящую заявку от клиента (email/PDF/скан).

   * Загружает заявку в AI-сервис.

   * Сервис автоматически анализирует текст, извлекает параметры (товары, количество, сроки, условия) и проверяет их по внутренним каталогам.

   * Генерируется черновой КП в корпоративном шаблоне.

   * Менеджер проверяет КП, при необходимости редактирует и отправляет клиенту.

   * Система сохраняет все данные для анализа и улучшения модели.

* Особенности пилота:

   * Сначала ограниченный поток заявок (например, конкретный продуктовый сегмент или регион).

   * Сбор обратной связи от менеджеров и клиентов для улучшения качества.

   * Логирование всех шагов для дальнейшего анализа.


### Что считаем успешным пилотом

* Критерии успеха:

* * Сокращение времени подготовки КП ≥ 70%

* * Точность извлечения ключевых параметров ≥ 90%

* * Минимум 80% черновых КП не требуют ручных правок

* * Положительная оценка пользователей (NPS ≥ 8/10)

* * Отсутствие критических ошибок в данных и интеграциях

* Возможные пути развития проекта после пилота:

* * Расширение на все продуктовые сегменты и регионы.

* * Интеграция с CRM для автоматической отправки КП клиенту.

* * Подключение генерации коммерческих условий и скидок на основе правил.

* * Обучение модели на реальных КП для повышения точности и улучшения формулировок.


## 3. Что входит в скоуп проекта/итерации

* В рамках итерации мы закрываем:

* * Разработка прототипа модели (LLM/VLLM) для извлечения ключевых параметров из заявок (текст, PDF, сканы).

* * Генерация черновых коммерческих предложений на основе внутреннего каталога продукции и бизнес-правил.

* * Интеграция с ограниченным набором входных форматов (PDF, текстовые файлы).

* * Метрики качества модели: точность извлечения ≥ 90%, корректность наименований ≥ 80%.

* * Логирование и сохранение всех данных для анализа и дальнейшего обучения.

* Вне скоупа итерации:

* * Полная интеграция со всеми системами ERP/CRM.

* * Обработка изображений/сканов с низким качеством OCR.

* * Автоматическая генерация условий скидок и ценовых предложений.

* * Поддержка всех сегментов продуктов компании.

* * Автоматическая отправка КП клиенту.


### На закрытие каких БТ подписываемся в данной итерации

* Извлечение ключевых параметров (товар, количество, сроки) из ограниченного набора форматов заявок.

* Генерация корректного чернового КП в едином шаблоне с минимальными ручными правками.

* Проверка соответствия наименований товаров внутреннему каталогу.

* Сбор метрик производительности модели и точности извлечения.

### Что не будет закрыто

* Расширение на все форматы входящих заявок и все продуктовые сегменты.

* Генерация коммерческих условий и индивидуальных скидок.

* Полная интеграция с внешними системами (CRM/ERP) для автоматической отправки КП.

* Долгосрочная оптимизация LLM для стиля текста и креативной генерации.

### Описание результата с точки зрения качества кода и воспроизводимости решения

* Качество кода:

* * Чистая, модульная архитектура для обработки входящих файлов и генерации КП.

* * Покрытие ключевых функций юнит-тестами (извлечение параметров, генерация текста).

* * Документация функций и шагов обработки данных.

* Воспроизводимость решения:

* * Возможность повторно обучить/дообучить модель на новых данных.

* * Легкая смена каталога продукции и бизнес-правил без изменения кода.

* * Логирование всех шагов обработки для анализа и отладки.

### Планируемый технический долг

* Ограниченный набор форматов заявок (PDF/текст) — OCR для сканов с низким качеством пока не реализован.

* Частичная интеграция с ERP/CRM (API для массовой генерации КП пока не подключен).

* Статические правила для генерации наименований вместо динамического обучения модели на всех кейсах.

* Минимальная обработка ошибок редких кейсов и некорректных данных.

* Отложена автоматическая генерация условий/цен.


## 4. Предпосылки решения

### Горизонт и характер обработки
#### Горизонт анализа

* Поскольку функция — генерация КП в момент получения заявки, модель работает:

* * В режиме реального времени,

* * Сразу при загрузке файла менеджером.

* Обоснование: бизнес запросил сокращение цикла отклика клиенту → нужен быстрый inference.

### Гранулярность обработки

#### Модель должна работать на уровне одной заявки, независимо от других.

* Гранулярность:

   * Анализ одного документа (или одной цепочки писем).

   * Извлечение параметров конкретного заказа.

   * Генерация 1 чернового КП → ручная проверка → клиенту.

* Обоснование:
КП всегда привязано к конкретному запросу, цеплять другие документы нельзя — риск ошибки и нарушения требований клиента.

### Предпосылки о качестве данных
#### Предположения о текстах

* Данные преимущественно структурированно-неструктурированные (текст с частичной структурой).

* Присутствует вариативность терминов, но в пределах нормального переговорного процесса.

* OCR-проблемы минимальны — допускаем легкие искажения, но без сильных артефактов.

#### Обоснование:
Бизнес сказал, что большинство PDF — это исходные документы от клиентов, не сканы факсов.

#### Предположения о каталогах

* Каталоги актуальны и обновляются бизнесом.

* SKU(Stock keeping unit) уникальны.

* В каталоге достаточно данных, чтобы однозначно сформировать товарное наименование.

#### Обоснование:
LLM не может “догадаться”, если каталоги неполные → мы опираемся на готовые данные бизнеса.

### Предпосылки о работе LLM и логике системы
* Предпосылка о достаточности LLM

   * LLM сможет:

      * Корректно извлекать сущности (товар, количество, параметры).

      * Соотносить параметры с каталогом (через RAG или правила).

      * Генерировать корректное наименование на основе бизнес-логики.

* Обоснование:
Задача — комбинирование извлечения + генерации, что полностью соответствует LLM-based pipeline.

* Ограничения модели

   * Мы предполагаем, что:

   * * Модель не должна принимать решения о ценах, скидках, марже.

   * * Модель не оценивает бизнес-риск.

   * * Модель не делает финальную юридическую проверку документа.

* Обоснование:
Эти функции — зона ответственности менеджеров и ERP.


### Предпосылки о производительности

#### Модель должна работать:

* Inference ≤ 120 секунд

* Поддержка 20–50 запросов/день (пилот)

* Используем vLLM или аналогичный оптимизированный runtime

#### Обоснование: 
бизнес-процесс требует fast response → иначе КП потеряет ценность.


### Предпосылки об обучении и данных для модели

#### Предполагаем:

* У нас доступен корпус минимум 100–300 реальных КП для анализа стиля (не обязательно для обучения).

* У нас есть набор из 500–1000 заявок для отладки промптов и пайплайна.

* Fine-tuning не обязателен на первой итерации → достаточно RAG + prompting.

#### Обоснование:
* Бизнес хочет быстро получить работающий MVP, fine-tune — позже, после сбора фидбэка.

### Предпосылки по роли человека в цикле

#### Предполагаем:

* Финальная проверка КП → обязанность менеджера.

* Менеджер может исправить ошибки.

* Менеджер даёт обратную связь (система логирует исправления).

#### Обоснование:
* Фулл-автоматизация сейчас невозможна как юридически, так и методологически.


## 5. Постановка задачи
### Техническая цель проекта:
#### Построить ML/LLM-систему для автоматического формирования коммерческих предложений из клиентских заявок через последовательность этапов:

##### 1. Извлечение информаций поданных на вход

* Определение сущностей: товары, количество, параметры, сроки, условия.

##### 2. Сопоставление с внутренними справочниками

* Соотнесение извлечённых данных с каталогами, спецификациями, бизнес-правилами.

##### 3. Генерация структурированного документа 

* Формирование чернового КП в корпоративном шаблоне с обязательными разделами.

#### Тип задачи: pipeline извлечение → нормализация → генерация документа

## 6. Блок-схема
- [Схема архитектуры решения](https://github.com/Johannmbo/ML_Sys_Design_Project/blob/hw_1/%D0%A1%D1%85%D0%B5%D0%BC%D0%B0_%D1%8D%D1%82%D0%B0%D0%BF%D0%BD%D0%BE%D1%81%D1%82%D0%B8.png)


## hw_2
# Этапы решения задачи

### Этап 1. Подготовка данных

В данном разделе описаны источники данных, необходимые для обучения модели для предложений заявок, а также статус их доступности и качества.

#### 1.1. Таблица данных и сущностей

| Название данных / Сущность | Есть ли данные в компании (Источник) | Требуемый ресурс (Роли) | Проверено ли качество? (EDA) | Описание / Комментарий |
| :--- | :--- | :--- | :--- | :--- |
| **Целевая переменная**<br>(`deal_status` / `is_accepted`) | **Да**<br>`DEALS_HISTORY`<br>(Дамп таблицы заказов) | **Data Analyst / DS**<br>(SQL выгрузка) | **Частично (+/-)** | Таргет (Accepted/Rejected) присутствует. <br>**Проблема:** Выявлен дисбаланс классов (Accepted ~30%). Много записей в статусе `Pending` ("Цензурированные данные"), которые нужно либо исключить из обучения, либо использовать спец. методы (PU-learning). |
| **Текстовые признаки**<br>(`client_request`, `commercial_proposal`) | **Да**<br>`DWH.MESSAGES_LOG`<br>(Таблица переписки) | **Data Engineer**<br>(Настройка ETL для текстов) | **Да (+)** | Тексты полные, длина достаточная. <br>**Риск:** Возможны вкрапления HTML-тегов, смайликов (персональных данных: телефоны, имена), требующие очистки на препроцессинге. |
| **Финансовые признаки**<br>(`budget_est`) | **Да**<br>`DWH.DEAL_METADATA` | **Data Scientist**<br>(Написание Regex парсера) | **Нет (-)** | **Критическая проблема качества:** Поле "грязное". Содержит смесь валют (`$`), фиксированных сумм (`500`) и ставок (`0.10/word`). Напрямую использовать нельзя, требуется сложная логика очистки и приведения к единому знаменателю. |
| **Категориальные признаки**<br>(`sector`, `date`) | **Да**<br>`DEAL_METADATA` | **Data Analyst** | **Да (+)** | Сектора (Web, Design и др.) заполнены корректно без пропусков. Дата позволяет сгенерировать фичи сезонности (день недели, месяц). |
| **Внешние данные**<br>(Курсы валют / Инфляция) | **Нет** | **Data Engineer** | **Нет** | Возможно потребуется для нормализации бюджетов, если данные накоплены за несколько лет (сейчас не используется). |

#### 1.2. Описание процесса генерации данных
Данные поступают в систему нерегулярно (по факту создания заказа клиентом).
1.  **Event:** Пользователь заполняет форму на сайте -> создается запись в БД (PostgreSQL).
2.  **Lifecycle:** Фрилансер отправляет предложение -> обновляется таблица предложений.
3.  **Finalization:** Клиент нажимает "Принять" или "Отклонить" -> обновляется статус в таблице заказов (Таргет).
*Процесс выгрузки для обучения:* Еженедельный дамп новых завершенных сделок в `S3 Bucket` или `Feature Store`.

#### 1.3. Конфиденциальность (Privacy)
Так как тексты заявок (`client_request`) могут содержать контакты и имена, перед передачей данных на обучение необходимо использовать **NER-маскирование** (замена сущностей на `<PERSON>`, `<PHONE>`).

#### 1.4. Краткое описание результата этапа (Выход)

Результатом этапа являются подготовленные витрины данных и зафиксированный обучающий датасет:

1.  **Обучающая выборка (Artefact):** CSV/Parquet файл `training_dataset_v1.csv`, содержащий:
    *   Очищенные тексты (lowercased, without punctuation).
    *   Спаршенный численный бюджет (`budget_numeric`).
    *   Бинарный таргет (`target`: 1=Accepted, 0=Rejected).
    *   Метаданные (сектор, дата).
2.  **Пайплайн предобработки (Code):** Скрипт `data_cleaning.py`, который умеет превращать "грязный" бюджет (строки типа "$0.10/word") в число.
3.  **Data Versioning:** Датасет зафиксирован в DVC (Data Version Control) для воспроизводимости экспериментов.

### Структура обучающей выборки

Перед описанием этапов моделирования фиксируем структуру обучающей выборки.

**Описание данных и сущностей (Feature Store):**

| Тип данных | Название атрибута | Описание и источник | Обработка (Feature Engineering) |
| :--- | :--- | :--- | :--- |
| **Target** | `target_is_accepted` | Бинарный флаг (1/0). Получен из маппинга поля `status`.<br>Mapping: `Accepted` -> 1, `{Rejected, Pending, Negotiating}` -> 0. | **Важно:** `Pending` в MVP исключаем из train-set, так как судьба сделки неизвестна (Censored Data), либо размечаем отдельной моделью. |
| **Features (Text)** | `client_request` | Текст запроса клиента. | Clean -> Tokenize -> TF-IDF (Baseline) / Embeddings (MVP). |
| **Features (Text)** | `commercial_proposal` | Текст ответа исполнителя. | Выделение длины текста, наличия ключевых слов ("urgent", "guarantee"). Расчет `Similarity Score` между запросом и ответом. |
| **Features (Cat)** | `sector` | Отрасль (Web Dev, Design, etc). | One-Hot Encoding (OHE) или CatBoost Encoding. |
| **Features (Num)** | `budget_cleaned` | Очищенная сумма сделки. | Парсинг из `budget_est`. Для почасовых ставок (`/hour`, `/word`) применяется множитель (средняя длина проекта/текста из EDA), чтобы привести к Project Value. Log-transform для сглаживания "хвоста" дорогих заказов. |

### Этап 2. Подготовка прогнозных моделей

**2.1. Baseline (Минимальное рабочее решение)**
*   **Гипотеза:** Простые ключевые слова (например, "Wordpress" + "дешево") и категория заказа дают базовое предсказание вероятности продажи.
*   **Входные данные:** `client_request` (склеенный с `commercial_proposal`), `sector`, `budget_cleaned`.
*   **Техника решения:**
    *   **Векторизация:** `TfidfVectorizer` (max_features=500, stop_words='english').
    *   **Модель:** Будем использовать логистическую Регрессию (`LogisticRegression` из sklearn) для нашего безлайна.
    *   **Валидация:** Hold-out (разбиение 80/20 со стратификацией по таргету, так как EDA показало дисбаланс 30/70).
*   **Ожидаемый результат:** Скрипт `train_baseline.py` и файл модели `logreg_v1.pkl`. Метрика ROC-AUC > 0.60 / коэффицент детерминации (r2-score) > 0.60.

**2.2. MVP (Основное решение)**
*   **Гипотеза:** Успех сделки зависит от семантического соответствия (Semantic Match) ответа исполнителя запросу клиента, а также от адекватности цены рынку.
*   **Входные данные:** Раздельные тексты, явные признаки.
*   **Техника решения:**
    *   **Text Embedding:** Использование легковесного трансформера `all-MiniLM-L6-v2` для получения плотных векторов текстов Request и Proposal.
    *   **New Feature (Semantic Similarity):** Расчет косинусного расстояния между вектором Запроса и вектором Предложения. (Гипотеза: чем точнее ответ соответствует боли клиента, тем выше шанс).
    *   **Модель:** Градиентный бустинг (**CatBoostClassifier**). Он нативно работает с эмбеддингами и категориальными фичами (`sector`).
    *   **Валидация:** Stratified K-Fold (k=5), так как выборка мала (сотни примеров), кросс-валидация даст более устойчивую оценку.
*   **Ожидаемый результат:** Пайплайн обучения. ROC-AUC > 0.75. Сериализованный пайплайн.

### Этап 3. Интерпретация моделей (Validation & Interpretability)

*   **Техника:** Расчет **SHAP values** (SHapley Additive exPlanations).
*   **Вводные из EDA:** Мы знаем, что есть аномально дорогие заказы (>$5000), которые часто отклоняются.
*   **Что проверяем:**
    1.  Действительно ли рост `budget_cleaned` коррелирует со снижением вероятности покупки (или есть нелинейная зависимость)?
    2.  Какие слова в поле `commercial_proposal` имеют положительный вес (продающие триггеры)?
*   **Ожидаемый результат:** График Feature Importance и Summary Plot. Подтверждение от заказчика, что "логика модели не противоречит бизнесу".

### Этап 4. Интеграция бизнес-правил для метрик

*   **Бизнес-контекст:** Мы хотим максимизировать Revenue (выручку). Ложно-отрицательное предсказание для дорогого заказа (Model says "Reject", Client says "Accept") стоит нам дороже, чем ошибка на дешевом заказе.
*   **Метрика:** Взвешенный `Profit Score`:
    $$ \sum (TruePositive \times Budget \times Commission \%) - \sum (FalsePositive \times CostOfManagerTime) $$
*   **Ожидаемый результат:** Таблица сравнения Baseline vs MVP не по Accuracy, а по потенциальной выручке.

### Этап 5. Подготовка инференса (Serving)
*   **Техника:** Оборачиваем модель MVP в REST API (FastAPI).
*   **Специфика данных:** API принимает JSON с полями `{text, sector, proposal, budget_str}`. Внутри сервиса должен "на лету" происходить тот же препроцессинг `budget_str` (очистка валют), что и на этапе обучения.
*   **Ожидаемый результат:** Docker-контейнер, отдающий прогноз за < 200ms.

### Этап 6. Интеграция бизнес-правил (Post-processing)

*   **Правило "Safety Net":** Если сумма сделки > $3,000 (верхний квантиль по EDA), заявка **всегда** отправляется на ручную модерацию ("Human in the loop"), даже если модель предсказывает отказ. Риск потерять крупного клиента слишком велик.
*   **Правило "Low Confidence":** Если вероятность находится в "серой зоне" (0.4 – 0.6), ставить статус "Требует уточнения".
*   **Ожидаемый результат:** Реализация логического слоя (Policy Layer) поверх предикта модели.

### Этап 7. Подготовка финального отчета для бизнеса
*   **Состав отчета:**
    1.  Метрики на тестовой выборке (Baseline vs MVP).
    2.  Экономический расчет: сколько денег принесет внедрение модели (симуляция на исторических данных).
    3.  Примеры "Успешных" и "Провальных" кейсов.
*   **Ожидаемый результат:** Презентация для стейкхолдеров и решение о деплое на prod.